<!DOCTYPE html><html lang="en-za"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>ECS - Dynamic Port Mapping - DevCloud</title><meta name="description" content=" The Port Mapping Problem A popular function of containers is to run a service such as a web or application server to which clients connect to using HTTP, TCP or socket connections. By default, Docker will allocate a port from the host to the&hellip;"><meta name="generator" content="Publii Open-Source CMS for Static Site"><link rel="canonical" href="https://devcloud.co.za/ecs-dynamic-port-mapping/"><link rel="alternate" type="application/atom+xml" href="https://devcloud.co.za/feed.xml"><link rel="alternate" type="application/json" href="https://devcloud.co.za/feed.json"><meta property="og:title" content="ECS - Dynamic Port Mapping"><meta property="og:image" content="https://devcloud.co.za/media/posts/9/alb-arch.png"><meta property="og:site_name" content="DevCloud"><meta property="og:description" content=" The Port Mapping Problem A popular function of containers is to run a service such as a web or application server to which clients connect to using HTTP, TCP or socket connections. By default, Docker will allocate a port from the host to the&hellip;"><meta property="og:url" content="https://devcloud.co.za/ecs-dynamic-port-mapping/"><meta property="og:type" content="article"><link rel="shortcut icon" href="https://devcloud.co.za/media/website/cloud-icon-2.png" type="image/x-icon"><style>:root{--body-font:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Fira Sans","Droid Sans","Helvetica Neue",Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";--heading-font:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Fira Sans","Droid Sans","Helvetica Neue",Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";--logo-font:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Fira Sans","Droid Sans","Helvetica Neue",Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";--menu-font:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Fira Sans","Droid Sans","Helvetica Neue",Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol"}</style><link rel="stylesheet" href="https://devcloud.co.za/assets/css/style.css?v=c37594acf579eddd689835749263c87b"><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://devcloud.co.za/ecs-dynamic-port-mapping/"},"headline":"ECS - Dynamic Port Mapping","datePublished":"2020-07-24T00:11","dateModified":"2020-08-12T10:42","image":{"@type":"ImageObject","url":"https://devcloud.co.za/media/posts/9/alb-arch.png","height":521,"width":837},"description":" The Port Mapping Problem A popular function of containers is to run a service such as a web or application server to which clients connect to using HTTP, TCP or socket connections. By default, Docker will allocate a port from the host to the&hellip;","author":{"@type":"Person","name":"Jenade Moodley"},"publisher":{"@type":"Organization","name":"Jenade Moodley"}}</script></head><body><div class="site-container"><header class="top" id="js-header"><a class="logo" href="https://devcloud.co.za/">DevCloud</a><nav class="navbar js-navbar"><button class="navbar__toggle js-toggle" aria-label="Menu" aria-haspopup="true" aria-expanded="false"><span class="navbar__toggle-box"><span class="navbar__toggle-inner">Menu</span></span></button><ul class="navbar__menu"><li class="active-parent has-submenu"><span class="is-separator" aria-haspopup="true">AWS Cloud</span><ul class="navbar__submenu level-2" aria-hidden="true"><li class="has-submenu"><span class="is-separator" aria-haspopup="true">EFS</span><ul class="navbar__submenu level-3" aria-hidden="true"><li><a href="https://devcloud.co.za/improving-efs-performance-part-1/" target="_self">Improving EFS Performance</a></li></ul></li><li class="active-parent has-submenu"><span class="is-separator" aria-haspopup="true">ECS</span><ul class="navbar__submenu level-3" aria-hidden="true"><li class="active"><a href="https://devcloud.co.za/ecs-dynamic-port-mapping/" target="_self">Dynamic Port Mapping</a></li><li><a href="https://devcloud.co.za/ecs-monitor-container-level-cpu-and-memory-using-docker-stats-and-cloudwatch-metrics/" target="_self">Container-level monitoring with Docker stats</a></li></ul></li><li class="has-submenu"><span class="is-separator" aria-haspopup="true">ELB</span><ul class="navbar__submenu level-3" aria-hidden="true"><li><a href="https://devcloud.co.za/understanding-alb-least-outstanding-request/" target="_self">ALB - Least Outstanding Requests</a></li></ul></li></ul></li><li class="has-submenu"><span class="is-separator" aria-haspopup="true">Linux</span><ul class="navbar__submenu level-2" aria-hidden="true"><li class="has-submenu"><span class="is-separator" aria-haspopup="true">NFS</span><ul class="navbar__submenu level-3" aria-hidden="true"><li><a href="https://devcloud.co.za/the-nfs-buffer-cache/" target="_self">NFS Buffer Cache</a></li></ul></li></ul></li><li class="has-submenu"><span class="is-separator" aria-haspopup="true">About</span><ul class="navbar__submenu level-2" aria-hidden="true"><li><a href="https://devcloud.co.za/about-me/" target="_self">About Me</a></li><li><a href="https://devcloud.co.za/about-this-website/" target="_self">About this Site</a></li></ul></li></ul></nav></header><main><article class="post"><div class="hero"><figure class="hero__image hero__image--overlay"><img src="https://devcloud.co.za/media/posts/9/alb-arch.png" srcset="https://devcloud.co.za/media/posts/9/responsive/alb-arch-xs.png 300w, https://devcloud.co.za/media/posts/9/responsive/alb-arch-sm.png 480w, https://devcloud.co.za/media/posts/9/responsive/alb-arch-md.png 768w, https://devcloud.co.za/media/posts/9/responsive/alb-arch-lg.png 1024w, https://devcloud.co.za/media/posts/9/responsive/alb-arch-xl.png 1360w, https://devcloud.co.za/media/posts/9/responsive/alb-arch-2xl.png 1600w" sizes="(max-width: 1600px) 100vw, 1600px" loading="eager" height="521" width="837" alt=""></figure><header class="hero__content"><div class="wrapper"><div class="post__meta"><time datetime="2020-07-24T00:11">July 24, 2020</time></div><h1>ECS - Dynamic Port Mapping</h1><div class="post__meta post__meta--author"><img src="https://devcloud.co.za/media/website/39186496_1809180909164306_8750795900512632832_o.jpg" loading="eager" alt="Jenade Moodley" class="post__author-thumb"> <a href="https://devcloud.co.za/authors/jenade-moodley/" class="feed__author invert">Jenade Moodley</a></div></div></header></div><div class="wrapper post__entry"><h2 id="the-port-mapping-problem">The Port Mapping Problem</h2><p>A popular function of containers is to run a service such as a web or application server to which clients connect to using HTTP, TCP or socket connections. By default, Docker will allocate a port from the host to the container from the ephemeral port range, but you can manually map or expose a specific host port, such as mapping port 80 on the host to port 8080 on the container. This works fine for individual containers and tasks, but if you need to run another container of the same type, you would then need another host as you cannot bind more than one container to a specific host port (i.e. if there is a container or service listening on a specific port such as port 80, no other service or container can use or bind that specific port.</p><p>Additionally, if your container is lightweight and uses minimal CPU and memory resources, this results in resource wastage as you would need to launch an entirely new instance simply to cater for this port conflict. If you wish to configure reactive scaling (i.e. scale the number of containers due to demand), this is also a blocking factor as this means that you either need additional EC2 instances on standby (increased cost), or spin up a new instance in accordance to demand (slower scale time). You would have to accurately map and plan your port usage on your EC2 hosts such that you can launch your containers without port conflicts, which increases management overhead.</p><h2 id="enter-dynamic-port-mapping">Enter Dynamic Port Mapping</h2><p>If you are going to be using multiple containers to host a service, you would also need to configure a suitable and robust solution in order to access each of these containers. When considering HTTP requests, a popular choice in AWS is to use the Application Load Balancer (ALB), often called a Layer 7 load balancer (referring to layer 7 Application layer in the <a href="https://www.cloudflare.com/learning/ddos/glossary/open-systems-interconnection-model-osi/" target="_blank">OSI model</a>, hence the name). An ALB will allow you to effectively distribute (or balance) requests to multiple targets to which it is connected to. While the port on the ALB to which you will issue requests to will always remain the same (port 80 for HTTP requests, and port 443 for HTTPS requests), the back end targets can each be listening on a different port, for example one target can be listening on port 8080, another can be listening on port 8000, etc. Multiple targets can even belong on the same EC2 instance, provided that the ports are different.</p><p>Using this functionality, we can apply this behaviour to containers. We can run the containers without specifying the port mapping (i.e. allow Docker to map the container port to an ephemeral port on the host), and then configure these containers to be targets for the ALB. This would allow you to run multiple containers of the same type, on the same EC2 instance, effectively reducing cost and management overhead. The ECS service is also capable of determining which host port your container has been bound to, and can configure the target registration for that specific port and container on the ALB, which allows for a seamless configuration.</p><h2 id="setting-up-dynamic-port-mapping">Setting up Dynamic Port Mapping</h2><p>Dynamic Port Mapping is relatively easy to configure. From the ECS service side, all you need to do is set the "Host" port in the container mapping to "0". A JSON snippet of the task definition would therefore look like this:</p><pre class="line-numbers language-json"><code>"portMappings": [
        {
          "hostPort": 0,
          "protocol": "tcp",
          "containerPort": 80
        }
      ]</code></pre><p>However, additional configurations may need to be done on your VPC and container instances in order to allow the connections to successfully reach the container. As the containers will be mapped to the ephemeral ports of the host, you would need to ensure the following criteria is met:</p><ol><li>The security groups attached to your container instances or tasks allow for incoming connections on the ephemeral port range from the ALB nodes.</li><li>The NACLs used by the subnet in which your tasks or container instances are located must allow inbound and outbound connections on the ephemeral port range.</li></ol><p>The ephemeral port range used by Docker versions 1.6.0 and later will refer to the&nbsp;<code>/proc/sys/net/ipv4/ip_local_port_range</code> kernel parameter on the host. If this kernel parameter is not available, or if you are using an earlier version of Docker, the default ephemeral port range is used, which ranges from ports&nbsp;49153 through 65535. In general,&nbsp;ports below 32768 fall outside of the ephemeral port range. As a general rule of thumb, you can allow incoming connections from ports 32768 through 65535 in order to account for both scenarios and avoid any issues.</p><h2 id="considerations">Considerations</h2><p>As you can now have multiple containers running on a single host to which you can connect to using your ALB, a logical consideration is having too many containers on the same host. This can cause resource contention, and can cause containers to be stopped if the configurations are too restrictive. You should actively configure task and container memory and CPU limits so that each container will be given ample resources on the host in order to function effectively.</p></div><footer class="wrapper post__footer"><p class="post__last-updated">This article was updated on August 12, 2020</p><ul class="post__tag"><li><a href="https://devcloud.co.za/blog/alb/">ALB</a></li><li><a href="https://devcloud.co.za/blog/aws/">AWS</a></li><li><a href="https://devcloud.co.za/blog/ecs/">ECS</a></li></ul><div class="post__share"><a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fdevcloud.co.za%2Fecs-dynamic-port-mapping%2F" class="js-share facebook" rel="nofollow noopener noreferrer"><svg class="icon" aria-hidden="true" focusable="false"><use xlink:href="https://devcloud.co.za/assets/svg/svg-map.svg#facebook"/></svg> <span>Facebook</span> </a><a href="https://twitter.com/share?url=https%3A%2F%2Fdevcloud.co.za%2Fecs-dynamic-port-mapping%2F&amp;via=DevCloud&amp;text=ECS%20-%20Dynamic%20Port%20Mapping" class="js-share twitter" rel="nofollow noopener noreferrer"><svg class="icon" aria-hidden="true" focusable="false"><use xlink:href="https://devcloud.co.za/assets/svg/svg-map.svg#twitter"/></svg> <span>Twitter</span> </a><a href="https://pinterest.com/pin/create/button/?url=https%3A%2F%2Fdevcloud.co.za%2Fecs-dynamic-port-mapping%2F&amp;media=https%3A%2F%2Fdevcloud.co.za%2Fmedia%2Fposts%2F9%2Falb-arch.png&amp;description=ECS%20-%20Dynamic%20Port%20Mapping" class="js-share pinterest" rel="nofollow noopener noreferrer"><svg class="icon" aria-hidden="true" focusable="false"><use xlink:href="https://devcloud.co.za/assets/svg/svg-map.svg#pinterest"/></svg> <span>Pinterest</span> </a><a href="http://www.linkedin.com/shareArticle?url=https%3A%2F%2Fdevcloud.co.za%2Fecs-dynamic-port-mapping%2F&amp;title=ECS%20-%20Dynamic%20Port%20Mapping" class="js-share linkedin" rel="nofollow noopener noreferrer"><svg class="icon" aria-hidden="true" focusable="false"><use xlink:href="https://devcloud.co.za/assets/svg/svg-map.svg#linkedin"/></svg> <span>LinkedIn</span> </a><a href="https://api.whatsapp.com/send?text=ECS%20-%20Dynamic%20Port%20Mapping https%3A%2F%2Fdevcloud.co.za%2Fecs-dynamic-port-mapping%2F" class="js-share whatsapp" rel="nofollow noopener noreferrer"><svg class="icon" aria-hidden="true" focusable="false"><use xlink:href="https://devcloud.co.za/assets/svg/svg-map.svg#whatsapp"/></svg> <span>WhatsApp</span></a></div><div class="post__bio bio"><img class="bio__avatar" src="https://devcloud.co.za/media/website/39186496_1809180909164306_8750795900512632832_o.jpg" loading="lazy" alt="Jenade Moodley"><div class="bio__info"><h3 class="bio__name"><a href="https://devcloud.co.za/authors/jenade-moodley/" class="invert" rel="author">Jenade Moodley</a></h3><p>Hi there. I&#x27;m a Cloud Engineer, currently working at AWS. I have a background in Computer Science, and gained reputable experience with Linux, Containers, and Cloud Architecture</p></div></div></footer></article><nav class="post__nav"><div class="post__nav-inner"><div class="post__nav-prev"><svg width="1.041em" height="0.416em" aria-hidden="true"><use xlink:href="https://devcloud.co.za/assets/svg/svg-map.svg#arrow-prev"/></svg> <a href="https://devcloud.co.za/about-this-website/" class="invert post__nav-link" rel="prev"><span>Previous</span> About this Website</a></div><div class="post__nav-next"><a href="https://devcloud.co.za/understanding-alb-least-outstanding-request/" class="invert post__nav-link" rel="next"><span>Next</span> Understanding Least Outstanding Requests ALB Load Balancing Algorithm </a><svg width="1.041em" height="0.416em" aria-hidden="true"><use xlink:href="https://devcloud.co.za/assets/svg/svg-map.svg#arrow-next"/></svg></div></div></nav><div class="post__comments"><div class="wrapper"><h2 class="h5">Comments</h2><div id="disqus_thread"></div><script>var disqus_config = function () {
                       this.page.url = 'https://devcloud.co.za/ecs-dynamic-port-mapping/';
               		this.page.identifier = '9';
                   };
               
                   var disqus_loaded = false;
               
                   function publiiLoadDisqus() {
                       if(disqus_loaded) {
                           return false;
                       }
               
                       var top = document.getElementById('disqus_thread').offsetTop;
               
                       if (!disqus_loaded && (window.scrollY || window.pageYOffset) + window.innerHeight > top) {
                           disqus_loaded = true;
               
                           (function () {
                               var d = document, s = d.createElement('script');
                               s.src = 'https://devcloud-co-za.disqus.com/embed.js';
                               s.setAttribute('data-timestamp', +new Date());
                               (d.head || d.body).appendChild(s);
                           })();
                       }
                   }
               
                   publiiLoadDisqus();
               
                   window.onscroll = function() {
                       publiiLoadDisqus();
                   };</script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" target="_blank" rel="nofollow noopener noreferrer">comments powered by Disqus.</a></noscript></div></div></main><footer class="footer"><div class="footer__copyright"><p>Powered by <a href="https://getpublii.com" target="_blank" rel="nofollow noopener">Publii Static CMS</a></p></div><button class="footer__bttop js-footer__bttop" aria-label="Back to top"><svg><title>Back to top</title><use xlink:href="https://devcloud.co.za/assets/svg/svg-map.svg#toparrow"/></svg></button></footer></div><script>window.publiiThemeMenuConfig = {    
        mobileMenuMode: 'sidebar',
        animationSpeed: 300,
        submenuWidth: 'auto',
        doubleClickTime: 500,
        mobileMenuExpandableSubmenus: true, 
        relatedContainerForOverlayMenuSelector: '.top',
   };</script><script defer="defer" src="https://devcloud.co.za/assets/js/scripts.min.js?v=f4c4d35432d0e17d212f2fae4e0f8247"></script><script>var images = document.querySelectorAll('img[loading]');

        for (var i = 0; i < images.length; i++) {
            if (images[i].complete) {
                images[i].classList.add('is-loaded');
            } else {
                images[i].addEventListener('load', function () {
                    this.classList.add('is-loaded');
                }, false);
            }
        }</script></body></html>