<!DOCTYPE html><html lang="en-za"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>ECS - Dynamic Port Mapping - DevCloud</title><meta name="description" content=" The Port Mapping Problem A popular function of containers is to run a service such as a web or application server to which clients connect to using HTTP, TCP or socket connections. By default, Docker will allocate a port from the host to the&hellip;"><meta name="generator" content="Publii Open-Source CMS for Static Site"><link rel="canonical" href="https://devcloud.co.za/ecs-dynamic-port-mapping/"><link rel="alternate" type="application/atom+xml" href="https://devcloud.co.za/feed.xml"><link rel="alternate" type="application/json" href="https://devcloud.co.za/feed.json"><meta property="og:title" content="ECS - Dynamic Port Mapping"><meta property="og:image" content="https://devcloud.co.za/media/posts/9/alb-arch.png"><meta property="og:site_name" content="DevCloud"><meta property="og:description" content=" The Port Mapping Problem A popular function of containers is to run a service such as a web or application server to which clients connect to using HTTP, TCP or socket connections. By default, Docker will allocate a port from the host to the&hellip;"><meta property="og:url" content="https://devcloud.co.za/ecs-dynamic-port-mapping/"><meta property="og:type" content="article"><link rel="shortcut icon" href="https://devcloud.co.za/media/website/cloud-icon-2.png" type="image/x-icon"><style>:root{--body-font:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Fira Sans","Droid Sans","Helvetica Neue",Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";--heading-font:var(--body-font);--post-entry-font:var(--body-font);--logo-font:var(--body-font);--menu-font:var(--body-font)}</style><link rel="stylesheet" href="https://devcloud.co.za/assets/css/style.css?v=1260ce06fb033e1ca9d336c8e4ed6742"><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://devcloud.co.za/ecs-dynamic-port-mapping/"},"headline":"ECS - Dynamic Port Mapping","datePublished":"2020-07-24T00:11","dateModified":"2020-08-12T10:42","image":{"@type":"ImageObject","url":"https://devcloud.co.za/media/posts/9/alb-arch.png","height":521,"width":837},"description":" The Port Mapping Problem A popular function of containers is to run a service such as a web or application server to which clients connect to using HTTP, TCP or socket connections. By default, Docker will allocate a port from the host to the&hellip;","author":{"@type":"Person","name":"Jenade Moodley"},"publisher":{"@type":"Organization","name":"Jenade Moodley"}}</script></head><body><header class="topbar" id="js-header"><div class="topbar__inner"><a class="logo" href="https://devcloud.co.za/">DevCloud</a><nav class="navbar"><button class="navbar__toggle" aria-label="Menu" aria-haspopup="true" aria-expanded="false"><span class="navbar__toggle-box"><span class="navbar__toggle-inner">Menu</span></span></button><ul class="navbar__menu"><li class="active-parent has-submenu"><span class="is-separator" aria-haspopup="true">AWS Cloud</span><ul class="navbar__submenu level-2" aria-hidden="true"><li class="has-submenu"><span class="is-separator" aria-haspopup="true">EFS</span><ul class="navbar__submenu level-3" aria-hidden="true"><li><a href="https://devcloud.co.za/improving-efs-performance-part-1/" target="_self">Why is my EFS slow?</a></li><li><a href="https://devcloud.co.za/improving-efs-performance-part-2/" target="_self">Improving EFS Performance</a></li></ul></li><li class="active-parent has-submenu"><span class="is-separator" aria-haspopup="true">ECS</span><ul class="navbar__submenu level-3" aria-hidden="true"><li class="active"><a href="https://devcloud.co.za/ecs-dynamic-port-mapping/" target="_self">Dynamic Port Mapping</a></li><li><a href="https://devcloud.co.za/ecs-monitor-container-level-cpu-and-memory-using-docker-stats-and-cloudwatch-metrics/" target="_self">Container-level monitoring with Docker stats</a></li><li><a href="https://devcloud.co.za/how-to-store-ecs-stopped-task-details/" target="_self">Storing Stopped ECS Task Details</a></li></ul></li><li class="has-submenu"><span class="is-separator" aria-haspopup="true">ELB</span><ul class="navbar__submenu level-3" aria-hidden="true"><li><a href="https://devcloud.co.za/understanding-alb-least-outstanding-request/" target="_self">ALB - Least Outstanding Requests</a></li></ul></li></ul></li><li class="has-submenu"><span class="is-separator" aria-haspopup="true">Linux</span><ul class="navbar__submenu level-2" aria-hidden="true"><li class="has-submenu"><span class="is-separator" aria-haspopup="true">NFS</span><ul class="navbar__submenu level-3" aria-hidden="true"><li><a href="https://devcloud.co.za/the-nfs-buffer-cache/" target="_self">NFS Buffer Cache</a></li></ul></li></ul></li><li class="has-submenu"><span class="is-separator" aria-haspopup="true">About</span><ul class="navbar__submenu level-2" aria-hidden="true"><li><a href="https://devcloud.co.za/about-me/" target="_self">About Me</a></li><li><a href="https://devcloud.co.za/about-this-website/" target="_self">About this Site</a></li></ul></li></ul></nav></div></header><div class="content"><div class="infobar"><div class="infobar__update">Last Updated: <time datetime="2022-02-07T00:17">February 7, 2022</time></div><div class="infobar__search"><form action="https://devcloud.co.za/search.html"><input type="search" name="q" placeholder="search..." aria-label="Search input"> <button type="submit" aria-label="Submit"><svg role="presentation" focusable="false" width="15px" height="14px"><use xlink:href="https://devcloud.co.za/assets/svg/svg-map.svg#search"/></svg></button></form></div></div><main class="main"><article class="post"><figure class="post__featured-image"><img src="https://devcloud.co.za/media/posts/9/alb-arch.png" srcset="https://devcloud.co.za/media/posts/9/responsive/alb-arch-xs.png 300w, https://devcloud.co.za/media/posts/9/responsive/alb-arch-sm.png 480w, https://devcloud.co.za/media/posts/9/responsive/alb-arch-md.png 768w, https://devcloud.co.za/media/posts/9/responsive/alb-arch-lg.png 1024w, https://devcloud.co.za/media/posts/9/responsive/alb-arch-xl.png 1360w, https://devcloud.co.za/media/posts/9/responsive/alb-arch-2xl.png 1600w" sizes="(max-width: 1600px) 100vw, 1600px" loading="eager" height="521" width="837" alt=""></figure><header class="u-header post__header"><h1>ECS - Dynamic Port Mapping</h1><div class="u-header__meta u-small"><img src="https://devcloud.co.za/media/website/39186496_1809180909164306_8750795900512632832_o.jpg" loading="eager" class="u-header__avatar" alt="Jenade Moodley" height="1439" width="1440"><div><a href="https://devcloud.co.za/authors/jenade-moodley/" title="Jenade Moodley">Jenade Moodley</a> <time datetime="2020-07-24T00:11">July 24, 2020 </time><a href="https://devcloud.co.za/blog/ecs/" class="u-tag u-tag--1">ECS</a></div></div></header><div class="post__entry u-inner"><h2 id="the-port-mapping-problem">The Port Mapping Problem</h2><p>A popular function of containers is to run a service such as a web or application server to which clients connect to using HTTP, TCP or socket connections. By default, Docker will allocate a port from the host to the container from the ephemeral port range, but you can manually map or expose a specific host port, such as mapping port 80 on the host to port 8080 on the container. This works fine for individual containers and tasks, but if you need to run another container of the same type, you would then need another host as you cannot bind more than one container to a specific host port (i.e. if there is a container or service listening on a specific port such as port 80, no other service or container can use or bind that specific port.</p><p>Additionally, if your container is lightweight and uses minimal CPU and memory resources, this results in resource wastage as you would need to launch an entirely new instance simply to cater for this port conflict. If you wish to configure reactive scaling (i.e. scale the number of containers due to demand), this is also a blocking factor as this means that you either need additional EC2 instances on standby (increased cost), or spin up a new instance in accordance to demand (slower scale time). You would have to accurately map and plan your port usage on your EC2 hosts such that you can launch your containers without port conflicts, which increases management overhead.</p><h2 id="enter-dynamic-port-mapping">Enter Dynamic Port Mapping</h2><p>If you are going to be using multiple containers to host a service, you would also need to configure a suitable and robust solution in order to access each of these containers. When considering HTTP requests, a popular choice in AWS is to use the Application Load Balancer (ALB), often called a Layer 7 load balancer (referring to layer 7 Application layer in the <a href="https://www.cloudflare.com/learning/ddos/glossary/open-systems-interconnection-model-osi/" target="_blank">OSI model</a>, hence the name). An ALB will allow you to effectively distribute (or balance) requests to multiple targets to which it is connected to. While the port on the ALB to which you will issue requests to will always remain the same (port 80 for HTTP requests, and port 443 for HTTPS requests), the back end targets can each be listening on a different port, for example one target can be listening on port 8080, another can be listening on port 8000, etc. Multiple targets can even belong on the same EC2 instance, provided that the ports are different.</p><p>Using this functionality, we can apply this behaviour to containers. We can run the containers without specifying the port mapping (i.e. allow Docker to map the container port to an ephemeral port on the host), and then configure these containers to be targets for the ALB. This would allow you to run multiple containers of the same type, on the same EC2 instance, effectively reducing cost and management overhead. The ECS service is also capable of determining which host port your container has been bound to, and can configure the target registration for that specific port and container on the ALB, which allows for a seamless configuration.</p><h2 id="setting-up-dynamic-port-mapping">Setting up Dynamic Port Mapping</h2><p>Dynamic Port Mapping is relatively easy to configure. From the ECS service side, all you need to do is set the "Host" port in the container mapping to "0". A JSON snippet of the task definition would therefore look like this:</p><pre class="line-numbers language-json"><code>"portMappings": [
        {
          "hostPort": 0,
          "protocol": "tcp",
          "containerPort": 80
        }
      ]</code></pre><p>However, additional configurations may need to be done on your VPC and container instances in order to allow the connections to successfully reach the container. As the containers will be mapped to the ephemeral ports of the host, you would need to ensure the following criteria is met:</p><ol><li>The security groups attached to your container instances or tasks allow for incoming connections on the ephemeral port range from the ALB nodes.</li><li>The NACLs used by the subnet in which your tasks or container instances are located must allow inbound and outbound connections on the ephemeral port range.</li></ol><p>The ephemeral port range used by Docker versions 1.6.0 and later will refer to the&nbsp;<code>/proc/sys/net/ipv4/ip_local_port_range</code> kernel parameter on the host. If this kernel parameter is not available, or if you are using an earlier version of Docker, the default ephemeral port range is used, which ranges from ports&nbsp;49153 through 65535. In general,&nbsp;ports below 32768 fall outside of the ephemeral port range. As a general rule of thumb, you can allow incoming connections from ports 32768 through 65535 in order to account for both scenarios and avoid any issues.</p><h2 id="considerations">Considerations</h2><p>As you can now have multiple containers running on a single host to which you can connect to using your ALB, a logical consideration is having too many containers on the same host. This can cause resource contention, and can cause containers to be stopped if the configurations are too restrictive. You should actively configure task and container memory and CPU limits so that each container will be given ample resources on the host in order to function effectively.</p></div><aside class="post__aside"><div class="post__last-updated u-small">This article was updated on August 12, 2020</div><div class="post__share"><a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fdevcloud.co.za%2Fecs-dynamic-port-mapping%2F" class="js-share facebook" title="Share with Facebook" rel="nofollow noopener noreferrer" aria-label="Share with Facebook"><svg class="u-icon"><use xlink:href="https://devcloud.co.za/assets/svg/svg-map.svg#facebook"/></svg> </a><a href="https://twitter.com/share?url=https%3A%2F%2Fdevcloud.co.za%2Fecs-dynamic-port-mapping%2F&amp;via=DevCloud&amp;text=ECS%20-%20Dynamic%20Port%20Mapping" class="js-share twitter" title="Share with Twitter" rel="nofollow noopener noreferrer" aria-label="Share with Twitter"><svg class="u-icon"><use xlink:href="https://devcloud.co.za/assets/svg/svg-map.svg#twitter"/></svg> </a><a href="https://pinterest.com/pin/create/button/?url=https%3A%2F%2Fdevcloud.co.za%2Fecs-dynamic-port-mapping%2F&amp;media=https%3A%2F%2Fdevcloud.co.za%2Fmedia%2Fposts%2F9%2Falb-arch.png&amp;description=ECS%20-%20Dynamic%20Port%20Mapping" class="js-share pinterest" title="Share with Pinterest" rel="nofollow noopener noreferrer" aria-label="Share with Pinterest"><svg class="u-icon"><use xlink:href="https://devcloud.co.za/assets/svg/svg-map.svg#pinterest"/></svg> </a><a href="https://wa.me/?text=ECS%20-%20Dynamic%20Port%20Mapping https%3A%2F%2Fdevcloud.co.za%2Fecs-dynamic-port-mapping%2F" class="js-share whatsapp" rel="nofollow noopener noreferrer" title="Share with WhatsApp" aria-label="Share with WhatsApp"><svg class="u-icon"><use xlink:href="https://devcloud.co.za/assets/svg/svg-map.svg#whatsapp"/></svg> </a><a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fdevcloud.co.za%2Fecs-dynamic-port-mapping%2F" class="js-share linkedin" title="Share with LinkedIn" rel="nofollow noopener noreferrer" aria-label="Share with LinkedIn"><svg class="u-icon"><use xlink:href="https://devcloud.co.za/assets/svg/svg-map.svg#linkedin"/></svg></a></div></aside><footer class="post__footer"><ul class="post__tag box"><li><a href="https://devcloud.co.za/blog/alb/" class="u-tag u-tag--1" title="ALB">ALB</a></li><li><a href="https://devcloud.co.za/blog/aws/" class="u-tag u-tag--1" title="AWS">AWS</a></li><li><a href="https://devcloud.co.za/blog/ecs/" class="u-tag u-tag--1" title="ECS">ECS</a></li></ul><div class="post__bio box"><img class="u-author__avatar" src="https://devcloud.co.za/media/website/39186496_1809180909164306_8750795900512632832_o.jpg" loading="lazy" alt="Jenade Moodley" height="1439" width="1440"><div><h4 class="h6"><a href="https://devcloud.co.za/authors/jenade-moodley/" title="Jenade Moodley">Jenade Moodley</a></h4><p>Hi there. I&#x27;m a Cloud Engineer, currently working at AWS. I have a background in Computer Science, and gained reputable experience with Linux, Containers, and Cloud Architecture</p></div></div><nav class="post__nav box"><div class="post__nav__prev"><a href="https://devcloud.co.za/about-this-website/" class="post__nav__link" rel="prev"><img src="https://devcloud.co.za/media/posts/8/responsive/Optimizing-Images-for-The-Web-xs.jpg" loading="lazy" alt="" height="979" width="2156"><div class="u-small">Previous Post<h5>About this Website</h5></div></a></div><div class="post__nav__next"><a href="https://devcloud.co.za/understanding-alb-least-outstanding-request/" class="post__nav__link" rel="next"><div class="u-small">Next Post<h5>Understanding Least Outstanding Requests ALB Load Balancing Algorithm</h5></div></a></div></nav></footer></article><div class="comments box"><h3 class="box__title">Comments</h3><div id="disqus_thread"></div><script>var disqus_config = function () {
                    this.page.url = 'https://devcloud.co.za/ecs-dynamic-port-mapping/';
                    this.page.identifier = '9';
                };
                var disqus_element_to_check = document.getElementById('disqus_thread');
            
                if ('IntersectionObserver' in window) {
                    var iObserver = new IntersectionObserver(
                        (entries, observer) => {
                            entries.forEach(entry => {
                                if (entry.intersectionRatio >= 0.1) {
                                    (function () {
                                        var d = document, s = d.createElement('script');
                                        s.src = 'https://'+'devcloud-co-za'.trim()+'.disqus.com/embed.js';
                                        s.setAttribute('data-timestamp', +new Date());
                                        (d.head || d.body).appendChild(s);
                                    })();
                                    observer.unobserve(entry.target);
                                }
                            });
                        },
                        {
                            threshold: [0, 1]
                        }
                    );
            
                    iObserver.observe(disqus_element_to_check);
                } else {
                    (function () {
                        var d = document, s = d.createElement('script');
                        s.src = 'https://'+'devcloud-co-za'.trim()+'.disqus.com/embed.js';
                        s.setAttribute('data-timestamp', +new Date());
                        (d.head || d.body).appendChild(s);
                    })();
                }</script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript></div></main><div class="sidebar"><section class="box featured"><h3 class="box__title">Featured</h3><ul class="featured__container"><li class="featured__item"><a href="https://devcloud.co.za/how-to-store-ecs-stopped-task-details/" class="featured__image-link"><img src="https://devcloud.co.za/media/posts/14/responsive/df8a5c58-68a2-4f99-bc4d-3e080890d13a-xs.jpg" class="lazyload" loading="lazy" alt="" height="619" width="619"></a><div><a href="https://devcloud.co.za/how-to-store-ecs-stopped-task-details/" class="featured__title">How to store ECS Stopped Task Details</a> <time class="u-small" datetime="2020-10-08T16:43">October 8, 2020</time></div></li><li class="featured__item"><div><a href="https://devcloud.co.za/the-nfs-buffer-cache/" class="featured__title">The NFS Buffer Cache</a> <time class="u-small" datetime="2020-07-25T16:44">July 25, 2020</time></div></li><li class="featured__item"><div><a href="https://devcloud.co.za/understanding-alb-least-outstanding-request/" class="featured__title">Understanding Least Outstanding Requests ALB Load Balancing Algorithm</a> <time class="u-small" datetime="2020-07-24T00:36">July 24, 2020</time></div></li><li class="featured__item"><a href="https://devcloud.co.za/improving-efs-performance-part-2/" class="featured__image-link"><img src="https://devcloud.co.za/media/posts/7/responsive/AWS_EFS-system_DIMq8h4-xs.jpg" class="lazyload" loading="lazy" alt="" height="624" width="624"></a><div><a href="https://devcloud.co.za/improving-efs-performance-part-2/" class="featured__title">Improving EFS Performance</a> <time class="u-small" datetime="2020-07-17T23:57">July 17, 2020</time></div></li><li class="featured__item"><a href="https://devcloud.co.za/improving-efs-performance-part-1/" class="featured__image-link"><img src="https://devcloud.co.za/media/posts/6/responsive/AWS_EFS-system_DIMq8h4-xs.jpg" class="lazyload" loading="lazy" alt="" height="624" width="624"></a><div><a href="https://devcloud.co.za/improving-efs-performance-part-1/" class="featured__title">Why is my EFS slow?</a> <time class="u-small" datetime="2020-07-16T23:10">July 16, 2020</time></div></li></ul></section><section class="box u-ads"><h3 class="u-ads__title">Advertisement</h3><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4779588160411156" crossorigin="anonymous"></script><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4779588160411156" data-ad-slot="9127304575" data-ad-format="auto" data-full-width-responsive="true"></ins><script>(adsbygoogle = window.adsbygoogle || []).push({});</script></section><section class="box authors"><h3 class="box__title">Authors</h3><ul class="authors__cotainer"><li class="authors__item"><a href="https://devcloud.co.za/authors/jenade-moodley/" class="authors__image-link"><img src="https://devcloud.co.za/media/website/39186496_1809180909164306_8750795900512632832_o.jpg" loading="lazy" alt="Jenade Moodley" height="1439" width="1440"></a><div><a href="https://devcloud.co.za/authors/jenade-moodley/" class="authors__title">Jenade Moodley</a> <span class="u-small">Post: 9</span></div></li></ul></section><section class="box"><h3 class="box__title">Tags</h3><ul class="tags"><li><a href="https://devcloud.co.za/blog/alb/">ALB</a> <span class="u-small">(2)</span></li><li><a href="https://devcloud.co.za/blog/aws/">AWS</a> <span class="u-small">(6)</span></li><li><a href="https://devcloud.co.za/blog/docker/">Docker</a> <span class="u-small">(1)</span></li><li><a href="https://devcloud.co.za/blog/ecs/">ECS</a> <span class="u-small">(3)</span></li><li><a href="https://devcloud.co.za/blog/efs/">EFS</a> <span class="u-small">(2)</span></li></ul></section></div><footer class="footer"><a class="footer__logo" href="https://devcloud.co.za/">DevCloud</a><nav><ul class="footer__nav"></ul></nav><div class="footer__copyright"><p>Powered by Publii</p></div></footer></div><script>window.publiiThemeMenuConfig = {    
        mobileMenuMode: 'sidebar',
        animationSpeed: 300,
        submenuWidth: 'auto',
        doubleClickTime: 500,
        mobileMenuExpandableSubmenus: true, 
        relatedContainerForOverlayMenuSelector: '.navbar',
   };</script><script defer="defer" src="https://devcloud.co.za/assets/js/scripts.min.js?v=bb66f1d815180573784f8434c8f0bf78"></script><script>var images = document.querySelectorAll('img[loading]');

      for (var i = 0; i < images.length; i++) {
         if (images[i].complete) {
               images[i].classList.add('is-loaded');
         } else {
               images[i].addEventListener('load', function () {
                  this.classList.add('is-loaded');
               }, false);
         }
      }</script></body></html>